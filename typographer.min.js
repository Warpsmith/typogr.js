/*!
  * typographer.js
  * Copyright(c) 2011 Eugene Kalinin
  * MIT Licensed
  */(function(a){var b=function(){},c={Typographer:b,version:"0.3.0"};typeof module!="undefined"&&module.exports?module.exports=c:a.typographer=c,b.prototype.typogrify=function(a){a=this.amp(a),a=this.widont(a),a=this.smartypants(a),a=this.quotes(a),a=this.ord(a);return a},b.prototype.amp=function(a){var b=/(\s|&nbsp;)(&|&amp;|&\#38;)(\s|&nbsp;)/g,c=/(<[^<]*>)?([^<]*)(<\/[^<]*>)?/g;if(!!a)return a.replace(c,function(a,c,d,e){var c=c||"",e=e||"",d=d.replace(b,'$1<span class="amp">&amp;</span>$3');return c+d+e})},b.prototype.ord=function(a){var b=/(\d+)(st|nd|rd|th)/g;if(!!a)return a.replace(b,'$1<span class="ord">$2</span>')},b.prototype.quotes=function(a){var b=new RegExp("(?:(?:<(?:p|h[1-6]|li|dt|dd)[^>]*>|^)\\s*(?:<(?:a|em|span|strong|i|b)[^>]*>s*)*)(?:(\"|&ldquo;|&#8220;)|('|&lsquo;|&#8216;))","i");if(!!a)return a.replace(b,function(a,b,c){var d=b?"dquo":"quo",e=b?b:c;return[a.slice(0,a.lastIndexOf(e)),'<span class="',d,'">',e,"</span>"].join("")})},b.prototype.widont=function(a){var b=new RegExp("((?:</?(?:a|em|span|strong|i|b)[^>]*>)|[^<>\\s])\\s+([^<>\\s]+\\s*(</(a|em|span|strong|i|b)>\\s*)*((</(p|h[1-6]|li|dt|dd)>)|$))","gi");return a.replace(b,"$1&nbsp;$2")},b.prototype.smartypants=function(a){var b=this,c=this.tokenize(a),d=[],e=/<(\/)?(pre|code|kbd|script|math)[^>]*>/i,f=[],g="",h="",i=!1,j="",k,l;c.forEach(function(a){if(a.type==="tag")d.push(a.txt),(h=e.exec(a.txt))!=null&&(g=h[2].toLowerCase(),h[1]?(f.length>0&&g===f[-1]&&f.pop(),f.length===0&&(i=!1)):(f.push(g),i=!0));else{l=a.txt,k=l.slice(-1);if(!i){l=b.smartEscapes(l),l=b.smartDashes(l),l=b.smartEllipses(l),l=b.smartBackticks(l);switch(l){case"'":/\S/.test(j)?l="&#8217;":l="&#8216;";break;case'"':/\S/.test(j)?l="&#8221;":l="&#8220;";break;default:l=b.smartQuotes(l)}}j=k,d.push(l)}});return d.join("")},b.prototype.tokenize=function(a){var b=[],c=0,d=/([^<]*)(<[^>]*>)/gi,e;while((e=d.exec(a))!=null){var f=e[1],g=e[2];f&&b.push({type:"text",txt:f}),b.push({type:"tag",txt:g}),c=d.lastIndex}d.lastIndex<=a.length&&b.push({type:"text",txt:a.slice(c)});return b},b.prototype.smartEscapes=function(a){return a.replace(/\\"/g,"&#34;").replace(/\\'/g,"&#39;").replace(/\\-/g,"&#45;").replace(/\\\./g,"&#46;").replace(/\\\\/g,"&#92;").replace(/\\`/g,"&#96;")},b.prototype.smartDashes=function(a){return a.replace(/---/g,"&#8211;").replace(/--/g,"&#8212;")},b.prototype.smartEllipses=function(a){return a.replace(/\.\.\./g,"&#8230;").replace(/\. \. \./g,"&#8230;")},b.prototype.smartBackticks=function(a){return a.replace(/``/g,"&#8220;").replace(/''/g,"&#8221;")},b.prototype.smartQuotes=function(a){var b="[!\"#$%'()*+,-./:;<=>?@[\\]^_`{|}~]",c="(?=%s\\B)".replace("%s",b),d="[^ \t\r\n[{(-]",e="&#8211;|&#8212;",f=new RegExp("(s           |&nbsp;       |--           |&[mn]dash;   |"+e+"|"+"&#x201[34];"+")"+"'"+"(?=w)","g"),g=new RegExp("("+d+")"+"'"+"(?!s | s\b | d)","g"),h=new RegExp("("+d+")"+"'"+"(?!s | s\b)","g"),i=new RegExp("(s           |&nbsp;       |--           |&[mn]dash;   |"+e+"|"+"&#x201[34];"+")"+'"'+"(?=w)","g"),j=new RegExp('"(?=s)',"g"),k=new RegExp("("+d+')"',"g");return a.replace(new RegExp("^'%s".replace("%s",c),"g"),"&#8217;").replace(new RegExp('^"%s'.replace("%s",c),"g"),"&#8221;").replace(/"'(?=\w)/g,"&#8220;&#8216;").replace(/'"(?=\w)/g,"&#8216;&#8220;").replace(/\b'(?=\d{2}s)/g,"&#8217;").replace(f,"$1&#8216;").replace(g,"$1&#8217;").replace(h,"$1&#8217;$2").replace("'","&#8216;").replace(i,"$1&#8220;").replace(j,"&#8221;").replace(k,"$1&#8221;").replace('"',"&#8220;")}})(this)